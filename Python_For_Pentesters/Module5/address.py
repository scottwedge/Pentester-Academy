#!/usr/bin/env python

import immlib

DESC = 'Find Instructions'

def main(args):

    imm = immlib.Debugger()

    assembledInstruction = imm.assemble(' '.join(args))

    if not assembledInstruction:
        return "[-] No instructions Given"

    addressList = imm.search(assembledInstruction)

    td = imm.createTable("Instruciton Locations", ['Module','Base Address','Instruction Address','Instruction'])
    #Add support to view the page info for modules
    for address in addressList:

        module = imm.findModule(address)
        if not module:
            imm.log("Address: 0x%08X not found in any Module" %address)
            continue
        
        instruction = ''
        numArgs = len(' '.join(args).split('\n'))

        for count in range(0,numArgs):
            instruction+= imm.disasmForward(address,nlines=count).getDisasm() + ' '
            
        td.add(0, [module[0],
                    str('0x%08X' %module[1]),
                    str('0x%08X' %address),
                    instruction
                    ])
        
    return "Success!"


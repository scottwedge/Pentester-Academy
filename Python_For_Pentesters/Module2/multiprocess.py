from multiprocessing import Process, Queue
from scapy.all import *
import sys
import Queue as TQ

#Multitprocessing Queue is different from normal queue. Multiprocesing queue cant verify the empty() check so we import the normal queue to do so and no such method called task_done in multiprocessing queue so no need to call it.

def WorkerProcess(ip,pid,q):
    while True:
        port = 0
        try:
            port = q.get(block=False)   #To tell it to exit in case no block are left i.e block=False
        except  TQ.Empty : 
            print "Worker %d exiting...." %pid
            return 0
        response = sr1(IP(dist=ip)/TCP(dport=port, flags="S"),verbose=False,timeout=2)  #Scappy TCP packet
        if response:
            if response[TCP].flags == 18:               #Scappy response
                print "Thread %d: Received port number %d open" %(pid,port)

que = Queue()

for j in range(1,100):
    que.put(j)

workers=[]

for i in range(1,3):
    print "Creating worker: %d" %i
    w = Process(target = WorkerProcess, args=(sys.argv[1],i,que))
    w.start()
    workers.append(w)
    print "WorkerThread %d created" %i


